<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HUGFIT ì¶œì„ì²´í¬</title>
  <style>
    body { font-family: 'Arial'; text-align: center; background: #f7f7f7; padding: 30px; }
    img { max-width: 200px; margin-bottom: 20px; }
    input { padding: 10px; font-size: 16px; width: 80%; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 5px; }
    button {
      padding: 12px 24px; background-color: #4da3ff; border: none;
      color: white; font-size: 16px; border-radius: 5px; cursor: pointer;
    }
    button:hover { background-color: #3d8bdb; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    p { color: #888; margin-top: 0; }
    .kakao { margin-top: 40px; }
    .kakao button {
      background-color: #fee500; color: #000; font-weight: bold;
    }
    .kakao button:hover { background-color: #e6cf00; }
    .status { 
      padding: 10px; 
      margin: 20px 0; 
      border-radius: 5px; 
      font-weight: bold;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    .info { background: #d1ecf1; color: #0c5460; }
    .loading { background: #e2e3e5; color: #6c757d; }
    .member-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }
    .member-info h3 {
      margin-top: 0;
      color: #495057;
      text-align: center;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-weight: bold;
      color: #6c757d;
    }
    .info-value {
      color: #495057;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 2s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <img src="https://raw.githubusercontent.com/silaskim-0722/hugfitmember-in/0cbe487104764f87d7939df2399a35f9672383c1/hugfit-logo.png" alt="HUGFIT ë¡œê³ " />
  <h2>í—ˆê·¸í• ì¶œì„ ì²´í¬</h2>

  <input type="text" id="name" placeholder="ì˜ˆ: ê¹€ë¯¼ì •" />
  <p>ì˜¤ëŠ˜ ë‚ ì§œ: <span id="today"></span></p>

  <button id="attendBtn" onclick="markAttendance()">ì¶œì„ì™„ë£Œ</button>

  <div id="statusMessage" style="display: none;"></div>
  <div id="memberInfo" style="display: none;"></div>

  <div class="kakao">
    <a href="https://open.kakao.com/me/fitcouple" target="_blank">
      <button>ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜í•˜ê¸°</button>
    </a>
  </div>

  <script>
    // API URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbw3UXzSQbI6jIIVEbUYMCaHKQS4izqki9kJXO5oOORcKyid6tpofsFKtsE9K433IN2Ulw/exec';
    
    // í‘œì‹œìš© ë‚ ì§œ
    const now = new Date();
    const displayDate = `${now.getMonth() + 1}ì›” ${now.getDate()}ì¼`;
    document.getElementById("today").innerText = displayDate;

    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showStatus(message, type = 'info', showSpinner = false) {
      const statusDiv = document.getElementById('statusMessage');
      const spinnerHtml = showSpinner ? '<div class="loading-spinner"></div>' : '';
      statusDiv.innerHTML = spinnerHtml + message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      
      if (!showSpinner) {
        // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€ (ë¡œë”© ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);
      }
    }

    // íšŒì› ì •ë³´ í‘œì‹œ í•¨ìˆ˜
    function showMemberInfo(memberData) {
      const infoDiv = document.getElementById('memberInfo');
      
      let statusText = '';
      let statusClass = '';
      
      if (memberData.type === 'ì¿ í°') {
        statusText = memberData.count > 0 ? `${memberData.count}íšŒ ë‚¨ìŒ` : 'ì‚¬ìš©ì™„ë£Œ';
        statusClass = memberData.count > 0 ? 'success' : 'error';
      } else {
        const today = new Date();
        const expireDate = new Date(memberData.expire);
        const daysLeft = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysLeft > 0) {
          statusText = `${daysLeft}ì¼ ë‚¨ìŒ`;
          statusClass = daysLeft > 7 ? 'success' : 'warning';
        } else {
          statusText = 'ê¸°ê°„ë§Œë£Œ';
          statusClass = 'error';
        }
      }
      
      infoDiv.innerHTML = `
        <div class="member-info">
          <h3>${memberData.name} ë‹˜ì˜ ì´ìš©ê¶Œ ì •ë³´</h3>
          <div class="info-row">
            <span class="info-label">ë“±ë¡ì¼:</span>
            <span class="info-value">${memberData.regDate}</span>
          </div>
          <div class="info-row">
            <span class="info-label">ì´ìš© ìœ í˜•:</span>
            <span class="info-value">${memberData.type}</span>
          </div>
          <div class="info-row">
            <span class="info-label">ë‚¨ì€ íšŸìˆ˜/ê¸°ê°„:</span>
            <span class="info-value">${memberData.type === 'ì¿ í°' ? `${memberData.count}íšŒ` : `~ ${memberData.expire}`}</span>
          </div>
          <div class="info-row">
            <span class="info-label">ìµœê·¼ ë°©ë¬¸:</span>
            <span class="info-value">${memberData.lastVisit || 'ì—†ìŒ'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">ìƒíƒœ:</span>
            <span class="info-value">
              <span class="status ${statusClass}" style="display: inline-block; padding: 4px 8px; font-size: 12px;">
                ${statusText}
              </span>
            </span>
          </div>
        </div>
      `;
      infoDiv.style.display = 'block';
    }

    // API í˜¸ì¶œ í•¨ìˆ˜
    async function callAPI(action, data = {}) {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: action,
          ...data
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      return await response.json();
    }

    async function markAttendance() {
      const name = document.getElementById("name").value.trim();
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];  // YYYY-MM-DD
      const attendBtn = document.getElementById("attendBtn");

      if (!name) {
        showStatus("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
        return;
      }

      // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
      attendBtn.disabled = true;
      attendBtn.textContent = "ì²˜ë¦¬ ì¤‘...";
      showStatus("íšŒì› ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...", "loading", true);

      try {
        // 1ë‹¨ê³„: íšŒì› ì •ë³´ í™•ì¸
        const memberResult = await callAPI('getMember', { name: name });
        
        if (!memberResult.success) {
          showStatus("ë“±ë¡ë˜ì§€ ì•Šì€ íšŒì›ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        const memberInfo = memberResult.data;
        
        // 2ë‹¨ê³„: ì´ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        if (memberInfo.type === 'ì¿ í°' && memberInfo.count <= 0) {
          showStatus("ë‚¨ì€ ì´ìš© íšŸìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.", "error");
          showMemberInfo(memberInfo);
          return;
        }
        
        if (memberInfo.type === 'ê¸°ê°„') {
          const todayDate = new Date();
          const expireDate = new Date(memberInfo.expire);
          if (todayDate > expireDate) {
            showStatus("ì´ìš© ê¸°ê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.", "error");
            showMemberInfo(memberInfo);
            return;
          }
        }

        // 3ë‹¨ê³„: ë‹¹ì¼ ì¤‘ë³µ ì¶œì„ í™•ì¸
        if (memberInfo.lastVisit === dateStr) {
          showStatus("ì˜¤ëŠ˜ ì´ë¯¸ ì¶œì„ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "warning");
          showMemberInfo(memberInfo);
          return;
        }

        // 4ë‹¨ê³„: ì¶œì„ ì²˜ë¦¬
        showStatus("ì¶œì„ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...", "loading", true);
        
        const attendResult = await callAPI('markAttendance', { 
          name: name,
          date: dateStr
        });

        if (attendResult.success) {
          // ì„±ê³µ ë©”ì‹œì§€ì™€ í•¨ê»˜ ì—…ë°ì´íŠ¸ëœ íšŒì› ì •ë³´ í‘œì‹œ
          const updatedMemberInfo = attendResult.memberData;
          showMemberInfo(updatedMemberInfo);
          showStatus(`${name} ë‹˜ì˜ ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`, "success");

          // 3ì´ˆ í›„ ì™„ë£Œ í™”ë©´ìœ¼ë¡œ ì „í™˜
          setTimeout(() => {
            showCompletionScreen(name, dateStr, updatedMemberInfo);
          }, 3000);
        } else {
          showStatus("ì¶œì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (attendResult.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"), "error");
        }

      } catch (error) {
        console.error('ì¶œì„ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        showStatus("ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "error");
      } finally {
        // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        attendBtn.disabled = false;
        attendBtn.textContent = "ì¶œì„ì™„ë£Œ";
      }
    }

    function showCompletionScreen(name, dateStr, memberInfo) {
      // ë‚¨ì€ íšŸìˆ˜/ê¸°ê°„ ì •ë³´
      let remainingInfo = '';
      if (memberInfo.type === 'ì¿ í°') {
        remainingInfo = memberInfo.count > 0 ? 
          `<p style="color: #28a745; font-size: 18px;">ğŸ« ë‚¨ì€ íšŸìˆ˜: <strong>${memberInfo.count}íšŒ</strong></p>` :
          `<p style="color: #dc3545; font-size: 18px;">âš ï¸ ì´ìš©ê¶Œì´ ëª¨ë‘ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
      } else {
        const today = new Date();
        const expireDate = new Date(memberInfo.expire);
        const daysLeft = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysLeft > 0) {
          remainingInfo = `<p style="color: #28a745; font-size: 18px;">ğŸ“… ë‚¨ì€ ê¸°ê°„: <strong>${daysLeft}ì¼</strong></p>`;
        } else {
          remainingInfo = `<p style="color: #dc3545; font-size: 18px;">âš ï¸ ì´ìš© ê¸°ê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
        }
      }

      document.body.innerHTML = `
        <div style="text-align:center; margin-top:50px;">
          <img src="https://raw.githubusercontent.com/silaskim-0722/hugfitmember-in/0cbe487104764f87d7939df2399a35f9672383c1/hugfit-logo.png" style="width:180px; margin-bottom:30px;">
          <h2 style="color: #175d47;">ì¶œì„ ì™„ë£Œ! ğŸ‰</h2>
          <p style="font-size: 20px; color: #175d47;">
            <strong>${name}</strong> ë‹˜ì˜ <strong>${dateStr}</strong> ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
          </p>
          ${remainingInfo}
          <div style="margin: 30px 0;">
            <button onclick="location.reload()" style="background-color: #6c757d; border: none; padding: 10px 20px; font-size: 16px; border-radius: 5px; color: white; margin-right: 10px; cursor: pointer;">
              ë‹¤ì‹œ ì¶œì„í•˜ê¸°
            </button>
          </div>
          <div class="kakao" style="margin-top: 40px;">
            <a href="https://open.kakao.com/me/fitcouple" target="_blank">
              <button style="background-color:#fee500; border:none; padding:10px 20px; font-size:16px; border-radius:5px; color:#000; cursor: pointer;">
                ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜í•˜ê¸°
              </button>
            </a>
          </div>
        </div>
      `;
    }

    // Enter í‚¤ë¡œ ì¶œì„ ì²˜ë¦¬
    document.getElementById('name').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        markAttendance();
      }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í¬ì»¤ìŠ¤
    window.onload = function() {
      document.getElementById('name').focus();
    };
  </script>
</body>
</html>